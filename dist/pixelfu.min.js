/*! pixelfu 28-12-2014 */
function Entity(){}function Gold(a,b,c,d){this.base=Entity,this.base.init(a,"gold",b,c,"gold","A glittering pile of dubloons\n{0} GP".format(d),!1,null,d/100),this.amount=d}function Scroll(a,b,c,d){this.base=Entity,this.base.init(a,"scroll",b,c,"scroll",d.description,!1,null,0),this.effect=d}function Potion(a,b,c,d){this.base=Entity,this.base.init(a,"potion",b,c,"potion","A gleaming green potion that looks delicious\n{0} HP".format(d),!1,null,d),this.HP=d}function Crate(a,b,c,d){this.base=Entity,this.base.init(a,"crate",b,c,"potion","A crate\nWho knows what mysteries lie inside?",!0,{mass:100},10*d),this.value=d}function Actor(a,b,c,d,e,f,g,h,i){this.base=Entity,this.base.init(a,b,c,d,e,!0,f,100*g),this.sentience=g,this.greediness=h,this.slowdown=i,this.direction=0}function preload(){game.frames=0,im=new IndicatorManager(game),game.im=im,rm=new RoomManager(game),game.rm=rm,level=new Level(game),level.preload(),game.level=level,player=new Player(game),player.preload(),game.player=player,players=game.add.group(),physics_entities=game.add.group(),entities=game.add.group()}function create(){game.world.setBounds(0,0,GAME_WIDTH*TILE_WIDTH,GAME_HEIGHT*TILE_WIDTH),game.physics.startSystem(Phaser.Physics.ARCADE),rm.create(),level.create(),player.create(),players.add(player.sprite),game.camera.follow(player.sprite,Phaser.Camera.FOLLOW_TOPDOWN),GameController.init({left:{type:"dpad",dpad:{up:{touchStart:function(){player.touchcontrols.up=!0},touchEnd:function(){player.touchcontrols.up=!1}},down:{touchStart:function(){player.touchcontrols.down=!0},touchEnd:function(){player.touchcontrols.down=!1}},left:{touchStart:function(){player.touchcontrols.left=!0},touchEnd:function(){player.touchcontrols.left=!1}},right:{touchStart:function(){player.touchcontrols.right=!0},touchEnd:function(){player.touchcontrols.right=!1}}}},right:{type:"buttons",buttons:[{label:"B",touchStart:function(){player.touchcontrols.shift=!0},touchEnd:function(){player.touchcontrols.shift=!1}},{label:"A",touchStart:function(){player.touchcontrols.space=!0},touchEnd:function(){player.touchcontrols.space=!1}},!1,!1]}})}function update(){game.frames++;var a=function(a,b){console.log(b),a.body.velocity={x:0,y:0},a.lifespan=4*Phaser.Timer.SECOND,level.map.recalculateTile(b.x,b.y,0),console.log(b)},b=function(a,b){console.log(a,b)};level.update(),player.update(),im.update(),physics_entities.callAll("update"),game.physics.arcade.collide(level.layer,level.baddie),game.physics.arcade.collide(level.layer,level.arrows,a),game.physics.arcade.collide(level.baddie,level.arrows,a),game.physics.arcade.collide(level.layer,player.sprite,b),game.physics.arcade.collide(level.layer,players)}function render(){for(var a=0;a<player.breadcrumbs.length;a++)game.debug.geom(player.breadcrumbs[a])}function RoomManager(a){this.game=a,this.rooms=[],this.edge_tiles=[]}Entity.prototype.init=function(a,b,c,d,e,f,g,h){if(this.game=a,this.sprite=a.add.sprite(TILE_WIDTH*c,TILE_WIDTH*d,b),this.type=e,this.description=f,g){a.physics.arcade.enable(this.sprite);for(var i in h)this.sprite.body[i]=h[i]}},Entity.prototype.update=function(){},Gold.prototype=new Entity,Scroll.prototype=new Entity,Potion.prototype=new Entity,Crate.prototype=new Entity,Actor.prototype=new Entity,Actor.prototype.update=function(){if(this.game.frames%this.sentience===0&&this.think(),this.game.frames%this.slowdown===0)switch(this.stepcountdown=0,this.direction){case 0:this.sprite.body.position.x+=TILE_WIDTH;break;case 1:this.sprite.body.position.y-=TILE_WIDTH;break;case 2:this.sprite.body.position.x-=TILE_WIDTH;break;case 3:this.sprite.body.position.y+=TILE_WIDTH}this.meets_action_condition()&&this.act()},Actor.prototype.think=function(){},Actor.prototype.meets_action_condition=function(){return!1},Actor.prototype.act=function(){},INDICATOR_SIZE=25,IndicatorManager=function(a){this.game=a,this.indicators=[],this.values={}},IndicatorManager.prototype={set:function(a,b){this.values[a]=b},update:function(){for(var a=0,b=this.indicators.length;b>a;a++)this.indicators[a].update()},add_indicator:function(a){var b=new Indicator(this,a.variable_name,this.indicators.length,a.minimum,a.maximum,a.color);this.indicators.push(b)}},Indicator=function(a,b,c,d,e,f){this.im=a,this.variable_name=b,this.position=c,this.minimum=d||0,this.maximum=e||100,this.color=f||16777215,this.box=game.add.graphics(0,0),this.box.fixedToCamera=!0,this.box.beginFill(this.color),this.box.drawRect(this.position*INDICATOR_SIZE,0,INDICATOR_SIZE,INDICATOR_SIZE)},Indicator.prototype={update:function(){this.box.alpha=(this.im.values[this.variable_name]-this.minimum)/(this.maximum-this.minimum)}};var Nadion={};Nadion.Controls=function(a,b,c){a.input.addPointer(),a.input.addPointer(),a.input.multiInputOverride=Phaser.Input.TOUCH_OVERRIDES_MOUSE;for(var d=a.input.pointer1,e=a.input.pointer2,f=b/c,g=[],h=0,i=0;c>i;i++){var j={left:h,right:h+f};g.push(j),h+=f}var k=[],l=[],m=function(a){return function(){var b;d.isDown&&(b=d.x);var c;return e.isDown&&(c=e.x),void 0!==b&&b>a.left&&b<a.right?1:void 0!==c&&c>a.left&&c<a.right?2:void 0}};for(i=0;c>i;i++){var n=g[i];k.push(m(n)),l.push(void 0)}var o=function(a,b,c){l[a]={callback:b,context:c}},p=function(a){for(var b=0;c>b;b++)l[b]&&a.x>g[b].left&&a.x<g[b].right&&l[b].callback.call(l[b].context)};a.input.onDown.add(p);var q=function(){a.load.image("button-left","dist/assets/button_left.png"),console.log("line is being executed as well"),a.load.image("button-right","dist/assets/button_right.png"),a.load.image("button-circle","dist/assets/button_square.png"),a.load.image("button-square","dist/assets/button_circle.png"),console.log("this line is being changed");var b=a.add.group();b.alpha=.33,b.visible=!0;var c=(f-64)/2,d=a.add.sprite(0,0,"button-left");d.fixedToCamera=!0,d.cameraOffset.x=g[0].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-right"),d.fixedToCamera=!0,d.cameraOffset.x=g[1].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-circle"),d.fixedToCamera=!0,d.cameraOffset.x=g[3].left+c,d.cameraOffset.y=320,b.add(d),d=a.add.sprite(0,0,"button-square"),d.fixedToCamera=!0,d.cameraOffset.x=g[4].left+c,d.cameraOffset.y=320,b.add(d)};return{buttonPressed:k,setOnPressedCallback:o,addButtons:q}},Level=function(a){this.game=a,this.monsters=[],this.main_arrow={}},Level.prototype={preload:function(){this.game.load.image("bullet","dist/assets/bullet.png"),this.game.load.image("specialbullet","dist/assets/specialbullet.png"),this.game.load.image("lrarrow","dist/assets/lrarrow.png"),this.game.load.image("udarrow","dist/assets/udarrow.png"),this.game.load.image("tiles","dist/assets/tiles.png"),this.game.load.image("baddie","dist/assets/space-baddie.png")},create:function(){this.map=game.add.tilemap(null,16,16,GAME_WIDTH,GAME_HEIGHT),this.map.addTilesetImage("tiles"),this.layer=this.map.create("base_layer",GAME_WIDTH,GAME_HEIGHT,TILE_WIDTH,TILE_WIDTH);for(var a=0;a<GAME_WIDTH;a++)for(var b=0;b<GAME_HEIGHT;b++)this.map.layers[0].data[a][b].index=this.game.rm.tilearray[a/2|0][b/2|0];this.map.setCollisionBetween(1,15,!0,this.layer["true"]),this.baddie=game.add.sprite(3*TILE_WIDTH,3*TILE_WIDTH,"baddie"),game.physics.arcade.enable(this.baddie),this.baddie.body.mass=100,this.layer.dirty=!0,this.arrows=game.add.group(),this.arrows.enableBody=!0,this.space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.ctrl=game.input.keyboard.addKey(Phaser.Keyboard.SHIFT)},update:function(){},fireArrow:function(a,b,c,d){switch(arrow=this.arrows.create(a.x,a.y,d),arrow.anchor.set(.5,.5),this.main_arrow=arrow,arrow.direction={x:1,y:0},b){case 0:arrow.direction={x:1,y:0},arrow.angle=0,arrow.body.position.x+=TILE_WIDTH,arrow.body.position.y+=TILE_WIDTH/2;break;case 1:arrow.direction={x:0,y:-1},arrow.angle=180,arrow.body.position.x+=TILE_WIDTH/2;break;case 2:arrow.direction={x:-1,y:0},arrow.angle=180,arrow.body.position.y+=TILE_WIDTH/2;break;case 3:arrow.direction={x:0,y:1},arrow.angle=0,arrow.body.position.x+=TILE_WIDTH/2,arrow.body.position.y+=TILE_WIDTH}return arrow.body.mass=10,arrow.body.velocity={x:arrow.direction.x*c,y:arrow.direction.y*c},arrow.body.collideWorldBounds=!0,arrow.direction=b,arrow.metadata={speed:c},arrow}},TILE_WIDTH=16,GAME_WIDTH=101,GAME_HEIGHT=101,CAMERA_WIDTH=25,CAMERA_HEIGHT=25,WIDTH=TILE_WIDTH*CAMERA_WIDTH,HEIGHT=TILE_WIDTH*CAMERA_HEIGHT;var game=new Phaser.Game(WIDTH,HEIGHT,Phaser.AUTO,"",{preload:preload,create:create,update:update,render:render});DRAW_MIN=8,DRAW_THRESHOLD=15,DRAW_MAX=57,MANA_MIN=0,MANA_THRESHOLD=15,MANA_MAX=25,NUM_BREADCRUMBS=5,BREADCRUMB_FRAMES=15,Player=function(a){this.game=a,this.sprite={},this.cursors=null,this.arrows=[],this.direction=0,this.manatimer=0,this.arrowtimer=0,this.nocked=!1,this.charging=!1,this.arrow_gen_time=25,this.mana_gen_time=25,this.speed=TILE_WIDTH/10,this.breadcrumbs=[],this.use_touch_controls=!this.game.device.desktop,this.touchcontrols={left:!1,right:!1,up:!1,down:!1,shift:!1,space:!1}},Player.prototype={preload:function(){this.game.load.image("box","dist/assets/box.png")},create:function(){this.sprite=game.add.sprite(0,0,"box"),game.physics.arcade.enable(this.sprite),this.sprite.body.collideWorldBounds=!0,this.cursors={},this.cursors=this.game.input.keyboard.createCursorKeys(),this.space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.shift=game.input.keyboard.addKey(Phaser.Keyboard.SHIFT),this.sprite.type="player",this.game.im.add_indicator({variable_name:"health",minimum:0,maximum:100,color:4310325,name:"Health Points"}),this.game.im.add_indicator({variable_name:"draw",minimum:DRAW_MIN,maximum:DRAW_MAX,color:16777215,name:"Draw Strength"}),this.game.im.add_indicator({variable_name:"mana",minimum:MANA_MIN,maximum:MANA_MAX,color:5607909,name:"Mana"}),this.indicators=this.game.im.values,this.indicators.health=100;for(var a=0;a<NUM_BREADCRUMBS;a++)this.breadcrumbs.push(new Phaser.Point(this.sprite.body.position.x,this.sprite.body.position.y))},update:function(){this.cursors.left.isDown||this.touchcontrols.left?(this.sprite.body.position.x-=this.speed,this.direction=2):this.cursors.right.isDown||this.touchcontrols.right?(this.sprite.body.position.x+=this.speed,this.direction=0):this.cursors.up.isDown||this.touchcontrols.up?(this.sprite.body.position.y-=this.speed,this.direction=1):(this.cursors.down.isDown||this.touchcontrols.down)&&(this.sprite.body.position.y+=this.speed,this.direction=3);var a=!1,b=!1;game.desktop?(a=this.shift.isDown,b=this.space.isDown):(a=this.touchcontrols.shift,b=this.touchcontrols.space),a?(this.charging=!0,this.indicators.mana=(this.indicators.mana+1).clamp(MANA_MIN,MANA_MAX)):(this.manatimer>this.mana_gen_time&&this.charging&&this.indicators.mana>MANA_THRESHOLD?(this.castMagic(this.indicators.mana/2|0),this.manatimer=0):this.manatimer++,this.charging=!1,this.indicators.mana=0),b?(this.nocked=!0,this.indicators.draw=(this.indicators.draw+1).clamp(DRAW_MIN,DRAW_MAX)):(this.arrowtimer>this.arrow_gen_time&&this.nocked&&this.indicators.draw>DRAW_THRESHOLD?(this.fireArrow(15*this.indicators.draw),this.arrowtimer=0):this.arrowtimer++,this.nocked=!1,this.indicators.draw=0),this.game.frames%BREADCRUMB_FRAMES===0&&(this.breadcrumbs.shift(),this.breadcrumbs.push(new Phaser.Point(this.sprite.body.position.x,this.sprite.body.position.y)))},castMagic:function(a){a-=a%2,console.log("did magic: ",a);var b=(this.game.level.map.layers[0].data,Math.floor(this.sprite.body.position.x/TILE_WIDTH)),c=Math.floor(this.sprite.body.position.y/TILE_WIDTH),d=Math.max(b-(a/2|0),0),e=Math.max(c-(a/2|0),0);this.game.level.map.fill(0,d,e,a,a,0),this.game.level.map.recalculateArea((d-2).clamp(0,GAME_WIDTH),(e-2).clamp(0,GAME_HEIGHT),a+4,a+4,0),this.game.level.map.layers[0].dirty=!0},fireArrow:function(a){var b=this.sprite.body.position,c=a,d=this.direction,e="lrarrow";d%2&&(e="udarrow"),this.arrows.push(this.game.level.fireArrow(b,d,c,e))}};var ROOM_DISTANCE_THRESHOLD=15,CONNECT_SPACES_THRESHOLD=.8,intersect_rooms=function(a,b){return a.x<b.x+b.width+3&&a.x+a.width+3>b.x&&a.y<b.y+b.height+3&&a.y+a.height+3>b.y},in_room=function(a,b){return a.x<b.x+b.width&&a.x>=b.x&&a.y<b.y+b.height&&a.y>=b.y},sketchy_room_distance=function(a,b){return Math.min(Math.abs(a.x-b.x)+Math.abs(a.y-b.y),Math.abs(a.x+a.width-b.x-b.width)+Math.abs(a.y+a.height-b.y-b.height))};debug=function(a){for(var b=0;b<GAME_HEIGHT;b++){buffer="";for(var c=0;c<GAME_WIDTH;c++)buffer+=a[c][b].toString();console.log(buffer)}},RoomManager.prototype.create=function(){this.tilearray=new Array(GAME_WIDTH),this.tilearray_metadata=new Array(GAME_WIDTH);for(var a=0;a<GAME_WIDTH;a++){this.tilearray[a]=new Int8Array(GAME_HEIGHT),this.tilearray_metadata[a]=new Int8Array(GAME_HEIGHT);for(var b=0;b<GAME_HEIGHT;b++)this.tilearray[a][b]=1,this.tilearray_metadata[a][b]={}}this.rooms=this.find_rooms(),this.carve_rooms(),this.carve_edges(),this.connect_spaces()},RoomManager.prototype.find_rooms=function(){var a=3,b=10,c=50,d=500,e=[];for(frustration=0,it=0;frustration<c&&it<d;){it++;for(var f=odd_range(a,b),g=odd_range(a,b),h={x:odd_range(0,GAME_WIDTH-f),y:odd_range(0,GAME_HEIGHT-g),width:f,height:g},i=!1,j=0;j<e.length;j++)if(intersect_rooms(e[j],h)){frustation++,i=!0;break}i||(e.push(h),frustation=0)}return e},RoomManager.prototype.carve_rooms=function(){for(var a=0;a<this.rooms.length;a++)for(var b=this.rooms[a],c=b.x,d=b.x+b.width;d>c;c++)for(var e=b.y,f=b.y+b.height;f>e;e++)this.tilearray[c][e]=0,this.tilearray_metadata[c][e]=1},RoomManager.prototype.num_adjacent_spaces=function(a,b){return(b+1<GAME_HEIGHT&&this.tilearray[a][b+1])+(b>0&&this.tilearray[a][b-1])+(a+1<GAME_WIDTH&&this.tilearray[a+1][b])+(a>0&&this.tilearray[a-1][b])},RoomManager.prototype.can_carve_edge=function(a,b){return this.num_adjacent_spaces(a,b)>2&&!this.adjacent_to_wall(a,b)},RoomManager.prototype.adjacent_to_wall=function(a,b){return b+1<GAME_HEIGHT&&1==this.tilearray_metadata[a][b+1]||b>0&&1==this.tilearray_metadata[a][b-1]||a+1<GAME_WIDTH&&1==this.tilearray_metadata[a+1][b]||a>0&&1==this.tilearray_metadata[a-1][b]},RoomManager.prototype.carve_edges=function(){for(var a=0;a<GAME_WIDTH;a+=2)for(var b=0;b<GAME_HEIGHT;b+=2)this.tilearray[a][b]&&this.can_carve_edge(a,b)&&this.recursive_carve(a,b)},RoomManager.prototype.recursive_carve=function(a,b){this.tilearray[a][b]=0,this.tilearray_metadata[a][b]=2,b+1<GAME_HEIGHT&&this.tilearray[a][b+1]&&this.can_carve_edge(a,b+1)&&this.recursive_carve(a,b+1),b>0&&this.tilearray[a][b-1]&&this.can_carve_edge(a,b-1)&&this.recursive_carve(a,b-1),a+1<GAME_WIDTH&&this.tilearray[a+1][b]&&this.can_carve_edge(a+1,b)&&this.recursive_carve(a+1,b),a>0&&this.tilearray[a-1][b]&&this.can_carve_edge(a-1,b)&&this.recursive_carve(a-1,b)},RoomManager.prototype.connect_spaces=function(){for(var a=0;a<GAME_WIDTH;a+=1)for(var b=0;b<GAME_HEIGHT;b+=1)this.tilearray[a][b]&&Math.random()>CONNECT_SPACES_THRESHOLD&&this.adjacent_to_wall(a,b)&&2==this.num_adjacent_spaces(a,b)&&(this.tilearray[a][b]=0)},Phaser.Tilemap.prototype.recalculateTile=function(a,b,c){var d=this.layers[c].data[b][a];d&&(above=this.getTileAbove(c,a,b),below=this.getTileBelow(c,a,b),left=this.getTileLeft(c,a,b),right=this.getTileRight(c,a,b),d.collides&&d.index?(d.faceTop=!0,d.faceBottom=!0,d.faceLeft=!0,d.faceRight=!0,d.collideUp=!0,d.collideDown=!0,d.collideLeft=!0,d.collideRight=!0):(d.faceTop=!1,d.faceBottom=!1,d.faceLeft=!1,d.faceRight=!1,d.collideUp=!1,d.collideDown=!1,d.collideLeft=!1,d.collideRight=!1),above&&above.collides&&(d.faceTop=!1),below&&below.collides&&(d.faceBottom=!1),left&&left.collides&&(d.faceLeft=!1),right&&right.collides&&(d.faceRight=!1))},Phaser.Tilemap.prototype.recalculateArea=function(a,b,c,d,e){"undefined"==typeof c&&(c=this.game.width),"undefined"==typeof d&&(d=this.game.height);for(var f=Math.min(a+c,this.game.width),g=Math.min(b+d,this.game.height),h=a;f>h;h++)for(var i=b;g>i;i++)this.recalculateTile(h,i,e)},Phaser.Tilemap.prototype.queue=[],Number.prototype.clamp=function(a,b){return Math.max(Math.min(b-1,this),a)},Number.prototype["in"]=function(a,b){return this>=a&&b>=this},String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),range=function(a,b){return Math.floor((b-a)*Math.random()+a)},odd_range=function(a,b){return 2*(Math.floor((b-a)*Math.random()+a)/2>>0)+1};